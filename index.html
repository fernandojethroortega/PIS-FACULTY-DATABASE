<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pagudpud Integrated School - Faculty Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
  :root { --blue:#0d3b66; --gold:#ffb703; --bg:#fff8e7; }
  body { font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; margin:0; background:var(--bg); }
  header { background:var(--blue); color:#fff; padding:15px 20px; text-align:center; font-size:1.4rem; position:relative; }
  #clock { position:absolute; top:8px; left:15px; font-size:0.9rem; }
  main { padding:20px; }
  .search-bar { margin-bottom:20px; text-align:center; }
  input[type="text"] { padding:10px; width:320px; border-radius:8px; border:1px solid #ccc; }
  .teacher-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(250px,1fr)); gap:15px; }
  .teacher-card { background:#fff; border-radius:12px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
  .teacher-photo { width:100px; height:100px; object-fit:cover; border-radius:50%; border:3px solid var(--gold); margin-bottom:10px; }
  .teacher-name { font-weight:bold; color:var(--blue); font-size:1.05rem; }
  .teacher-info { font-size:0.9rem; color:#333; margin-top:6px; }
  button { background:var(--blue); color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; }
  button:hover { background:var(--gold); color:var(--blue); }
  .modal { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20; }
  .modal-content { background:#fff; margin:6% auto; padding:20px; width:420px; border-radius:10px; }
  .close { float:right; color:red; cursor:pointer; font-size:1.2rem; }
</style>
</head>
<body>
<header>
  <div id="clock"></div>
  PAGUDPUD INTEGRATED SCHOOL â€” FACULTY DASHBOARD
</header>

<main>
  <div class="search-bar">
    <input id="searchInput" type="text" placeholder="Search teacher..." oninput="searchTeacher()">
  </div>
  <div id="teacherContainer" class="teacher-grid"></div>
</main>

<!-- View Modal -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Teacher Information</h3>
    <p><strong>Full Name:</strong> <span id="vFullName"></span></p>
    <p><strong>Position:</strong> <span id="vPosition"></span></p>
    <p><strong>Employee No.:</strong> <span id="vEmpNo"></span></p>
    <p><strong>Sex:</strong> <span id="vSex"></span></p>
    <p><strong>Age:</strong> <span id="vAge"></span></p>
    <p><strong>Address:</strong> <span id="vAddress"></span></p>
    <p><strong>Specialization:</strong> <span id="vSpec"></span></p>
    <p><strong>Email:</strong> <span id="vEmail"></span></p>
    <p><strong>Contact No.:</strong> <span id="vContact"></span></p>
  </div>
</div>

<script>
/* Simple clock */
function updateClock(){ document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
setInterval(updateClock,1000); updateClock();

/* Utilities */
function normalizeHeader(h){ return String(h||'').trim().toLowerCase(); }
function sanitizeKey(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,'_'); }
function genIdFromName(first,last,middle){ 
  const f = (first||'').trim().toLowerCase();
  const l = (last||'').trim().toLowerCase();
  const m = (middle||'').trim().toLowerCase().charAt(0) || '';
  return sanitizeKey(`${f}_${m}_${l}`) || ('id_' + Math.random().toString(36).slice(2,9));
}

/* Storage: load once */
let savedPhotos = {};
try { savedPhotos = JSON.parse(localStorage.getItem('teacherPhotos')||'{}'); } catch(e) { savedPhotos = {}; }

/* teacherData holds full rows plus meta: {id, normalized} */
let teacherData = [];

/* Load CSV from Google Sheets */
async function loadTeacherData(){
  const fileUrl = "https://docs.google.com/spreadsheets/d/1FJl1WywegQhwYHdAv_nf4ZmNrEI63sJfdP_83lD8lfk/export?format=csv";
  try {
    const res = await fetch(fileUrl);
    if(!res.ok) throw new Error('fetch failed: ' + res.status);
    const csv = await res.text();

    // Parse using SheetJS but normalize headers
    const wb = XLSX.read(csv, {type:'string'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    let raw = XLSX.utils.sheet_to_json(sheet, {defval: ''}); // array of objects

    // Normalize headers: build mapping of original -> normalized
    // We will create rows with normalized keys.
    teacherData = raw.map(row => {
      // Build normalized row object
      const normRow = {};
      for (const k in row) {
        const nk = normalizeHeader(k);
        normRow[nk] = row[k];
      }
      // Determine stable id: prefer employee number, else generate from name
      const empNo = (normRow['employee number'] || normRow['emp no'] || normRow['employee_no'] || '').toString().trim();
      const id = empNo ? sanitizeKey(empNo) : genIdFromName(normRow['first name'], normRow['last name'], normRow['middle name']);
      // Put photo from savedPhotos if exists (key is sanitized empNo or generated id)
      const photo = savedPhotos[id] || savedPhotos[empNo] || savedPhotos[ sanitizeKey(normRow['first name'] + '_' + normRow['last name']) ] || '';
      return { id, empNo, row: normRow, photo: photo || '' };
    });

    // Render
    renderCards(teacherData);
  } catch(err){
    console.error(err);
    alert('Failed to load sheet. Check link or internet. See console for details.');
  }
}

/* Render - using stable IDs for data-* attributes */
function renderCards(list){
  const container = document.getElementById('teacherContainer');
  container.innerHTML = '';
  list.forEach(item => {
    const r = item.row;
    const middleInitial = r['middle name'] ? (r['middle name'].charAt(0).toUpperCase() + '.') : '';
    const fullName = `${r['first name']||''} ${middleInitial} ${r['last name']||''}`.trim();
    const photoSrc = item.photo || 'https://via.placeholder.com/100?text=No+Photo';

    const card = document.createElement('div');
    card.className = 'teacher-card';
    card.innerHTML = `
      <img src="${photoSrc}" alt="photo" class="teacher-photo" data-emp="${item.id}" id="photo_${item.id}">
      <div class="teacher-name">${fullName}</div>
      <div class="teacher-info">
        <div>${r['position']||''}</div>
        <div style="font-size:0.85rem;color:#555">${r['email']||''}</div>
        <div style="font-size:0.85rem;color:#555">${r['contact number']||r['contact']||''}</div>
      </div>
      <button onclick="viewTeacher('${item.id}')">View</button>
      <br><br>
      <button onclick="triggerUpload('${item.id}')">Upload Photo</button>
      <input type="file" accept="image/*" style="display:none" id="file_${item.id}" data-emp="${item.id}">
    `;
    container.appendChild(card);

    // attach onchange handler once (safe even if re-render)
    const input = card.querySelector(`#file_${item.id}`);
    input.onchange = (e) => previewPhoto(e, item.id);
  });
}

/* Upload trigger uses data-emp id instead of numeric index */
function triggerUpload(empId){
  const input = document.getElementById(`file_${empId}`);
  if(input) input.click();
}

/* Preview & save image: store in savedPhotos using stable id */
function previewPhoto(evt, empId){
  const file = evt.target.files && evt.target.files[0];
  if(!file) return;
  const reader = new FileReader();
  reader.onload = function(e){
    const dataUrl = e.target.result;
    // Update displayed image (if present)
    const img = document.getElementById(`photo_${empId}`);
    if(img) img.src = dataUrl;

    // Save to savedPhotos with key empId (stable key)
    savedPhotos[empId] = dataUrl;
    try { localStorage.setItem('teacherPhotos', JSON.stringify(savedPhotos)); }
    catch(err){ console.error('localStorage set failed', err); alert('Cannot save photo to localStorage (storage full?)'); }

    // Also update teacherData entry so next render uses this photo
    const t = teacherData.find(x => x.id === empId);
    if(t) t.photo = dataUrl;
  };
  reader.readAsDataURL(file);
}

/* View teacher uses id */
function viewTeacher(empId){
  const t = teacherData.find(x => x.id === empId);
  if(!t) return alert('Teacher not found');
  const r = t.row;
  const middleInitial = r['middle name'] ? (r['middle name'].charAt(0).toUpperCase() + '.') : '';
  document.getElementById('vFullName').textContent = `${r['first name']||''} ${middleInitial} ${r['last name']||''}`.trim();
  document.getElementById('vPosition').textContent = r['position'] || '';
  document.getElementById('vEmpNo').textContent = t.empNo || '';
  document.getElementById('vSex').textContent = r['sex'] || '';
  document.getElementById('vAge').textContent = r['age'] || '';
  document.getElementById('vAddress').textContent = r['address'] || '';
  document.getElementById('vSpec').textContent = r['specialization'] || '';
  document.getElementById('vEmail').textContent = r['email'] || '';
  document.getElementById('vContact').textContent = r['contact number'] || r['contact'] || '';
  document.getElementById('viewModal').style.display = 'block';
}
function closeModal(){ document.getElementById('viewModal').style.display = 'none'; }

/* SEARCH: filter by any field - still uses teacherData (stable ids) */
function searchTeacher(){
  const q = (document.getElementById('searchInput').value || '').toLowerCase().trim();
  if(!q){ renderCards(teacherData); return; }
  const filtered = teacherData.filter(t => {
    // join row values
    return Object.values(t.row).join(' ').toLowerCase().includes(q);
  });
  renderCards(filtered);
}

/* Initial load */
loadTeacherData();
</script>
</body>
</html>
