<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pagudpud Integrated School - Faculty Dashboard</title>

<!-- Load SheetJS -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<style>
  :root {
    --blue: #0d3b66;
    --gold: #ffb703;
    --bg: #fff8e7;
  }
  body {
    font-family: "Segoe UI", Tahoma, Geneva, Verdana, sans-serif;
    margin: 0;
    background-color: var(--bg);
  }
  header {
    background-color: var(--blue);
    color: white;
    padding: 15px 20px;
    text-align: center;
    font-size: 1.5rem;
    font-weight: bold;
    position: relative;
  }
  #clock {
    position: absolute;
    top: 8px;
    left: 15px;
    font-size: 0.9rem;
  }
  main {
    padding: 20px;
  }
  .search-bar {
    margin-bottom: 20px;
    text-align: center;
  }
  input[type="text"] {
    padding: 10px;
    width: 300px;
    border: 1px solid #ccc;
    border-radius: 8px;
  }

  .teacher-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 15px;
  }
  .teacher-card {
    background: white;
    border-radius: 12px;
    box-shadow: 0 2px 6px rgba(0,0,0,0.1);
    padding: 15px;
    transition: transform 0.2s ease;
    text-align: center;
  }
  .teacher-card:hover {
    transform: translateY(-3px);
  }
  .teacher-photo {
    width: 100px;
    height: 100px;
    object-fit: cover;
    border-radius: 50%;
    border: 3px solid var(--gold);
    margin-bottom: 10px;
  }
  .teacher-name {
    font-weight: bold;
    color: var(--blue);
    font-size: 1.1rem;
  }
  .teacher-info {
    font-size: 0.9rem;
    color: #333;
    margin-top: 5px;
  }
  button {
    background-color: var(--blue);
    color: white;
    border: none;
    border-radius: 6px;
    padding: 6px 12px;
    margin-top: 8px;
    cursor: pointer;
  }
  button:hover {
    background-color: var(--gold);
    color: var(--blue);
  }

  .modal {
    display: none;
    position: fixed;
    z-index: 10;
    left: 0;
    top: 0;
    width: 100%;
    height: 100%;
    background-color: rgba(0,0,0,0.5);
  }
  .modal-content {
    background: white;
    margin: 8% auto;
    padding: 20px;
    border-radius: 10px;
    width: 400px;
    box-shadow: 0 2px 8px rgba(0,0,0,0.3);
  }
  .close {
    color: red;
    float: right;
    font-size: 1.3rem;
    cursor: pointer;
  }
  .close:hover {
    color: darkred;
  }
  h3 {
    color: var(--blue);
    border-bottom: 2px solid var(--gold);
    padding-bottom: 5px;
  }
</style>
</head>
<body>

<header>
  <div id="clock"></div>
  Pagudpud Integrated School - Faculty Dashboard
</header>

<main>
  <div class="search-bar">
    <input type="text" id="searchInput" placeholder="Search teacher..." onkeyup="searchTeacher()">
  </div>

  <div id="teacherContainer" class="teacher-grid"></div>
</main>

<!-- View Modal -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Teacher Information</h3>
    <p><strong>Full Name:</strong> <span id="vFullName"></span></p>
    <p><strong>Position:</strong> <span id="vPosition"></span></p>
    <p><strong>Employee No.:</strong> <span id="vEmpNo"></span></p>
    <p><strong>Sex:</strong> <span id="vSex"></span></p>
    <p><strong>Age:</strong> <span id="vAge"></span></p>
    <p><strong>Address:</strong> <span id="vAddress"></span></p>
    <p><strong>Specialization:</strong> <span id="vSpec"></span></p>
    <p><strong>Email:</strong> <span id="vEmail"></span></p>
    <p><strong>Contact No.:</strong> <span id="vContact"></span></p>
  </div>
</div>

<script>
/* CLOCK */
function updateClock() {
  const now = new Date();
  document.getElementById('clock').textContent = now.toLocaleTimeString();
}
setInterval(updateClock, 1000);
updateClock();

let teacherData = [];
let savedPhotos = JSON.parse(localStorage.getItem("teacherPhotos") || "{}"); // ✅ Load once

/* LOAD DATA FROM GOOGLE SHEET */
async function loadTeacherData() {
  const fileUrl = "https://docs.google.com/spreadsheets/d/1FJl1WywegQhwYHdAv_nf4ZmNrEI63sJfdP_83lD8lfk/export?format=csv";
  try {
    const response = await fetch(fileUrl);
    const csvData = await response.text();
    const workbook = XLSX.read(csvData, { type: "string" });
    const sheetName = workbook.SheetNames[0];
    const data = XLSX.utils.sheet_to_json(workbook.Sheets[sheetName]);
    
    teacherData = data.map(t => {
      const empNo = t["Employee Number"] || t["employee number"];
      const photo = savedPhotos[empNo] || "https://via.placeholder.com/100?text=No+Photo";
      return { ...t, photo };
    });

    renderCards(teacherData);
  } catch (error) {
    alert("Could not load teacher data. Please check your Google Sheet link.");
    console.error(error);
  }
}

/* RENDER TEACHER CARDS */
function renderCards(list) {
  const container = document.getElementById("teacherContainer");
  container.innerHTML = "";
  list.forEach((row, index) => {
    const r = {};
    for (let key in row) r[key.trim().toLowerCase()] = row[key];
    const middleInitial = r["middle name"] ? r["middle name"].charAt(0).toUpperCase() + "." : "";
    const fullName = `${r["first name"] || ""} ${middleInitial} ${r["last name"] || ""}`.trim();

    const card = document.createElement("div");
    card.classList.add("teacher-card");
    card.innerHTML = `
      <img src="${row.photo}" alt="Photo" class="teacher-photo" id="photo-${index}">
      <div class="teacher-name">${fullName}</div>
      <div class="teacher-info">
        <div>${r["position"] || ""}</div>
        <div style="font-size:0.85rem; color:#555;">${r["email"] || ""}</div>
        <div style="font-size:0.85rem; color:#555;">${r["contact number"] || ""}</div>
      </div>
      <button onclick="viewTeacher(${index})">View</button>
      <br>
      <button onclick="uploadPhoto(${index})">Upload Photo</button>
      <input type="file" accept="image/*" id="fileInput-${index}" style="display:none" onchange="previewPhoto(event, ${index})">
    `;
    container.appendChild(card);
  });
}

/* UPLOAD PHOTO */
function uploadPhoto(index) {
  document.getElementById(`fileInput-${index}`).click();
}

/* PREVIEW & SAVE PHOTO */
function previewPhoto(event, index) {
  const file = event.target.files[0];
  if (!file) return;
  const reader = new FileReader();
  reader.onload = function(e) {
    const photoURL = e.target.result;
    document.getElementById(`photo-${index}`).src = photoURL;
    teacherData[index].photo = photoURL;

    const empNo = teacherData[index]["Employee Number"] || teacherData[index]["employee number"];
    if (empNo) {
      savedPhotos[empNo] = photoURL;
      localStorage.setItem("teacherPhotos", JSON.stringify(savedPhotos)); // ✅ Persistent save
    }
  };
  reader.readAsDataURL(file);
}

/* VIEW TEACHER DETAILS */
function viewTeacher(index) {
  const t = teacherData[index];
  const r = {};
  for (let key in t) r[key.trim().toLowerCase()] = t[key];
  const middleInitial = r["middle name"] ? r["middle name"].charAt(0).toUpperCase() + "." : "";
  document.getElementById('vFullName').textContent = `${r["first name"] || ""} ${middleInitial} ${r["last name"] || ""}`;
  document.getElementById('vPosition').textContent = r["position"] || "";
  document.getElementById('vEmpNo').textContent = r["employee number"] || "";
  document.getElementById('vSex').textContent = r["sex"] || "";
  document.getElementById('vAge').textContent = r["age"] || "";
  document.getElementById('vAddress').textContent = r["address"] || "";
  document.getElementById('vSpec').textContent = r["specialization"] || "";
  document.getElementById('vEmail').textContent = r["email"] || "";
  document.getElementById('vContact').textContent = r["contact number"] || "";
  document.getElementById('viewModal').style.display = 'block';
}

/* CLOSE MODAL */
function closeModal() {
  document.getElementById('viewModal').style.display = 'none';
}

/* SEARCH FUNCTION */
function searchTeacher() {
  const query = document.getElementById('searchInput').value.toLowerCase();
  const filtered = teacherData.filter(t => Object.values(t).join(" ").toLowerCase().includes(query));
  renderCards(filtered);
}

loadTeacherData();
</script>

</body>
</html>
