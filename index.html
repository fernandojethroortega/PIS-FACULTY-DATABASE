<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Pagudpud Integrated School - Faculty Dashboard</title>
<style>
  :root { --blue:#0d3b66; --gold:#ffb703; --bg:#fff8e7; }
  body{font-family:Segoe UI, Tahoma, Geneva, Verdana, sans-serif;background:var(--bg);margin:0;color:#111}
  header{display:flex;flex-wrap:wrap;align-items:center;justify-content:space-between;background:var(--gold);color:var(--blue);padding:12px 16px;box-shadow:0 3px 8px rgba(0,0,0,.12)}
  .brand{display:flex;align-items:center;gap:12px}
  .brand img{width:72px;height:72px;border-radius:50%;object-fit:contain}
  .brand h1{font-size:18px;margin:0}
  .header-actions{display:flex;gap:8px;align-items:center}
  .icon-btn{background:transparent;border:1px solid rgba(13,59,102,0.15);padding:8px;border-radius:8px;cursor:pointer;display:flex;align-items:center;gap:8px}
  .icon-btn .emoji{font-size:18px}
  #adminLogin{display:flex;gap:6px;align-items:center}
  #adminLogin input{padding:6px;border-radius:6px;border:1px solid #ccc}
  #adminLogin button{background:var(--blue);color:#fff;border:none;padding:6px 10px;border-radius:6px;cursor:pointer}

  main{padding:14px}
  .topbar{display:flex;flex-wrap:wrap;gap:10px;justify-content:space-between;align-items:center;margin-bottom:12px}
  .search{flex:1;min-width:200px;max-width:520px}
  .search input{width:100%;padding:10px;border-radius:8px;border:1px solid #ccc;text-transform:uppercase}
  .controls{display:flex;gap:8px;flex-wrap:wrap;align-items:center}
  .controls button{background:var(--blue);color:#fff;border:none;padding:8px 12px;border-radius:8px;cursor:pointer}
  .controls button.secondary{background:var(--gold);color:var(--blue);border:1px solid var(--blue)}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left;vertical-align:top}
  th{background:var(--gold);color:var(--blue);text-transform:uppercase;font-size:12px}
  td small{display:block;color:#444;font-size:12px;margin-top:6px}
  .actions-cell{display:flex;gap:6px;flex-wrap:wrap}
  .pill{background:#f3f3f3;border-radius:6px;padding:4px 6px;font-size:12px}

  /* Modal */
  .modal{display:none;position:fixed;z-index:999;left:0;top:0;width:100%;height:100%;background:rgba(0,0,0,0.5);overflow:auto}
  .modal .panel{background:#fff;margin:4% auto;padding:14px;border-radius:10px;width:95%;max-width:920px;box-shadow:0 6px 18px rgba(0,0,0,.25)}
  .modal .panel h3{margin:0 0 8px 0;color:var(--blue)}
  .grid{display:grid;grid-template-columns:repeat(2,1fr);gap:8px}
  .grid .full{grid-column:1/3}
  input[type=text], input[type=email], input[type=number], select, textarea, input[type=time], input[type=date] { width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px; }
  label{font-size:13px;color:#222;margin-top:6px;display:block}
  .small{font-size:12px;color:#555}
  .row-actions{display:flex;gap:8px;margin-top:10px;justify-content:flex-end}
  .schedule-list{max-height:260px;overflow:auto;border:1px dashed #ddd;padding:8px;border-radius:6px;background:#fafafa}
  .schedule-item{display:flex;justify-content:space-between;gap:8px;padding:6px;border-bottom:1px solid #eee}
  .schedule-item:last-child{border-bottom:none}

  /* contingency table inline small */
  #contTable{width:100%;border-collapse:collapse;margin-top:12px}
  #contTable th, #contTable td{border:1px solid #ddd;padding:6px;font-size:13px}

  /* teacher info table */
  .info-table{width:100%;border-collapse:collapse;margin-top:8px}
  .info-table th, .info-table td{border:1px solid #eee;padding:8px;text-align:left;background:#fff}

  /* weekly schedule table */
  .week-table{width:100%;border-collapse:collapse;margin-top:8px;font-size:13px}
  .week-table th, .week-table td{border:1px solid #ddd;padding:6px;text-align:center;vertical-align:middle;background:#fff}
  .week-table th{background:var(--gold);color:var(--blue)}
  .class-block{background:#f0f8ff;padding:6px;border-radius:4px;font-size:12px}

  @media (max-width:920px){
    .modal .panel{max-width:96%}
  }
  @media (max-width:720px){
    .grid{grid-template-columns:1fr}
    header{padding:10px}
    .brand h1{font-size:16px}
    .search input{max-width:100%}
    .modal .panel{margin:10% 6%}
    th,td{font-size:12px}
  }
</style>
</head>
<body>

<header>
  <div class="brand">
    <img src="PIS OFFICIAL SEAL.png" alt="logo">
    <div>
      <h1>Pagudpud Integrated School</h1>
      <div class="small">Faculty Database ‚Äî Schedules ‚Äî Contingency</div>
    </div>
  </div>

  <div class="header-actions">
    <button class="icon-btn" title="Vacant Now" onclick="openVacantModal()">
      <span class="emoji">‚è≥</span><span>Vacant Now</span>
    </button>

    <button class="icon-btn" title="Check Vacant at day/time" onclick="openVacantChecker()">
      <span class="emoji">üîé</span><span>Check Vacant</span>
    </button>

    <button class="icon-btn" title="Teacher Schedules (list)" onclick="openSchedulesModal()">
      <span class="emoji">üìÖ</span><span>Schedules</span>
    </button>

    <button class="icon-btn" title="Contingency Plans" onclick="openContingencyModal()">
      <span class="emoji">üÜò</span><span>Contingency</span>
    </button>

    <div id="adminLogin">
      <input id="adminPass" type="password" placeholder="Admin password">
      <button onclick="adminLogin()">Admin</button>
    </div>
  </div>
</header>

<main>
  <div class="topbar">
    <div class="search"><input id="searchInput" placeholder="Search by name / position / specialization" oninput="renderTableFiltered()"></div>
    <div class="controls">
      <button onclick="triggerAdd()">‚ûï Add Teacher</button>
      <button class="secondary" onclick="exportCSV()">üì§ Export CSV</button>
      <button onclick="clearAllData()">üóëÔ∏è Clear All (Admin)</button>
    </div>
  </div>
<input type="file" id="importFile" accept="application/vnd.openxmlformats-officedocument.spreadsheetml.sheet,application/vnd.ms-excel,text/csv" style="display:none" onchange="importDataFromExcel(event)">
<button onclick="document.getElementById('importFile').click()">üì• Import Excel</button>

  <section>
    <table id="facultyTable" aria-live="polite">
      <thead>
        <tr>
          <th>#</th><th>Full Name</th><th>Position</th><th>Employee No.</th><th>Specialization</th><th>Schedules</th><th>Actions</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </section>

  <!-- Contingency quick table (recent plans) -->
  <section style="margin-top:14px;">
    <h3 style="margin:0 0 8px 0;color:var(--blue)">Recent Contingency Plans</h3>
    <table id="contTable">
      <thead><tr><th>#</th><th>Absent Teacher</th><th>Substitute</th><th>Subject</th><th>Room</th><th>Date</th><th>Time</th></tr></thead>
      <tbody></tbody>
    </table>
  </section>
</main>

<!-- Add/Edit Teacher Modal -->
<div id="teacherModal" class="modal" aria-hidden="true">
  <div class="panel" role="dialog" aria-modal="true">
    <h3 id="teacherModalTitle">Add Teacher</h3>
    <div class="grid">
      <div><label>First Name *</label><input id="t_first" type="text" placeholder="FIRST NAME"></div>
      <div><label>Middle Name *</label><input id="t_middle" type="text" placeholder="MIDDLE NAME"></div>
      <div><label>Last Name *</label><input id="t_last" type="text" placeholder="LAST NAME"></div>
      <div><label>Position *</label><input id="t_position" type="text" placeholder="POSITION"></div>
      <div><label>Employee Number *</label><input id="t_empno" type="text" placeholder="EMPLOYEE NUMBER"></div>
      <div><label>Sex *</label><select id="t_sex"><option value="">Select</option><option>MALE</option><option>FEMALE</option></select></div>
      <div><label>Age *</label><input id="t_age" type="number" min="18" placeholder="AGE"></div>
      <div><label>Contact Number *</label><input id="t_contact" type="text" placeholder="CONTACT"></div>
      <div class="full"><label>Address *</label><input id="t_address" type="text" placeholder="ADDRESS"></div>
      <div><label>Email (lowercase) *</label><input id="t_email" type="email" placeholder="email@example.com"></div>
      <div><label>Specialization *</label><input id="t_special" type="text" placeholder="SPECIALIZATION"></div>

      <div class="full">
        <label>Schedules (Day, Start - End, Subject, Room) ‚Äî Add one by one *</label>
        <div style="display:flex;gap:6px;flex-wrap:wrap;margin-bottom:6px">
          <select id="s_day" style="width:120px">
            <option value="">DAY</option>
            <option>MONDAY</option><option>TUESDAY</option><option>WEDNESDAY</option><option>THURSDAY</option><option>FRIDAY</option><option>SATURDAY</option><option>SUNDAY</option>
          </select>
          <input id="s_start" type="time" style="width:120px">
          <input id="s_end" type="time" style="width:120px">
          <input id="s_subject" type="text" placeholder="SUBJECT" style="flex:1">
          <input id="s_room" type="text" placeholder="ROOM" style="width:120px">
          <button onclick="addScheduleItem()" style="background:var(--gold);color:var(--blue);border:none;padding:8px;border-radius:6px;cursor:pointer">Add</button>
        </div>
        <div class="schedule-list" id="scheduleList" aria-live="polite"></div>
        <div class="small">Tip: Add all schedule rows for this teacher. Vacant & contingency use these schedules.</div>
      </div>

      <div class="full row-actions">
        <button onclick="saveTeacher()">Save</button>
        <button style="background:#ddd;color:var(--blue)" onclick="closeTeacherModal()">Cancel</button>
      </div>
    </div>
  </div>
</div>

<!-- Teacher Info Modal (full table) -->
<div id="infoModal" class="modal"><div class="panel"><h3>Teacher Information</h3>
  <table class="info-table" id="infoTable">
    <tbody></tbody>
  </table>
  <div class="row-actions"><button onclick="closeInfoModal()">Close</button></div>
</div></div>

<!-- Weekly Schedule Modal (per teacher) -->
<div id="weekModal" class="modal"><div class="panel"><h3 id="weekTitle">Weekly Schedule</h3>
  <div class="small">Columns: Monday ‚Üí Sunday. Rows show time slots for this teacher (sorted).</div>
  <div id="weekContainer" style="margin-top:10px;overflow:auto"></div>
  <div class="row-actions"><button onclick="closeWeekModal()">Close</button></div>
</div></div>

<!-- Vacant Now Modal -->
<div id="vacantModal" class="modal"><div class="panel"><h3>Vacant Teachers (Now)</h3>
  <div id="vacantListNow" class="schedule-list"></div>
  <div class="row-actions"><button onclick="closeVacantModal()">Close</button></div>
</div></div>

<!-- Vacant Checker Modal (day + time) -->
<div id="vacantCheckerModal" class="modal"><div class="panel"><h3>Check Vacant at Day & Time</h3>
  <div class="grid">
    <div><label>Day</label><select id="checker_day"><option value="">Select Day</option><option>MONDAY</option><option>TUESDAY</option><option>WEDNESDAY</option><option>THURSDAY</option><option>FRIDAY</option><option>SATURDAY</option><option>SUNDAY</option></select></div>
    <div><label>Time</label><input id="checker_time" type="time"></div>
    <div class="full small">Tip: Example input ‚Äî 16:00 = 4:00 PM. Then click "Check".</div>
  </div>

  <div style="margin-top:10px">
    <button onclick="runVacantChecker()">Check</button>
    <button style="background:#ddd;color:var(--blue)" onclick="closeVacantChecker()">Cancel</button>
  </div>

  <hr style="margin:12px 0">

  <div id="vacantCheckerResult" class="schedule-list"></div>

  <div class="row-actions" style="margin-top:8px"><button onclick="closeVacantChecker()">Close</button></div>
</div></div>

<!-- Schedules Modal (list) -->
<div id="schedulesModal" class="modal"><div class="panel"><h3>All Teacher Schedules</h3>
  <div id="allSchedules" class="schedule-list"></div>
  <div class="row-actions"><button onclick="closeSchedulesModal()">Close</button></div>
</div></div>

<!-- Contingency Modal -->
<div id="contModal" class="modal"><div class="panel">
  <h3>Contingency Plan Generator</h3>
  <div class="grid">
    <div>
      <label>Absent Teacher *</label>
      <select id="cont_absent">
        <option value="">Select Absent Teacher</option>
      </select>
    </div>
    <div>
      <label>Date of Absence *</label>
      <input id="cont_date" type="date">
    </div>
    <div>
      <label>Start Time *</label>
      <input id="cont_start" type="time">
    </div>
    <div>
      <label>End Time *</label>
      <input id="cont_end" type="time">
    </div>
    <div class="full"><label>Subject *</label><input id="cont_subject" type="text" placeholder="SUBJECT"></div>
    <div class="full"><label>Room *</label><input id="cont_room" type="text" placeholder="ROOM"></div>
  </div>

  <div style="margin-top:10px">
    <button onclick="findSubstitutes()">Find Available Substitutes</button>
    <button style="background:#ddd;color:var(--blue)" onclick="closeContingencyModal()">Cancel</button>
    <button style="background:#f1c40f;color:var(--blue);float:right" onclick="openContingencyList()">View Saved Plans</button>
  </div>

  <hr>

  <div id="contCandidates" class="schedule-list"></div>

  <div class="row-actions" style="margin-top:8px"><button onclick="closeContingencyModal()">Close</button></div>
</div></div>

<!-- Contingency List Modal -->
<div id="contListModal" class="modal"><div class="panel"><h3>Saved Contingency Plans</h3>
  <div id="contList" class="schedule-list"></div>
  <div style="margin-top:10px" class="row-actions">
    <button onclick="exportContingencyCSV()">Export Contingency CSV</button>
    <button style="background:#ddd;color:var(--blue)" onclick="closeContingencyList()">Close</button>
  </div>
</div></div>

<script>
/* ============================
  Combined system with:
  - faculty add/edit/delete/view
  - schedules per teacher
  - vacant checker
  - contingency plan generator
  - view complete teacher info (table)
  - view weekly schedule per teacher (table)
  - persistence via localStorage
  - admin access for edits (ADMIN123)
=============================*/

const STORAGE_KEY = 'pis_faculty_v_final';
const CONT_KEY = 'pis_contingency_v_final';
let faculty = JSON.parse(localStorage.getItem(STORAGE_KEY) || '[]');
let contingency = JSON.parse(localStorage.getItem(CONT_KEY) || '[]');
let adminAccess = false;
let editingIndex = -1;

/* Persist helpers */
function persist(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(faculty)); }
function persistCont(){ localStorage.setItem(CONT_KEY, JSON.stringify(contingency)); }

/* Auto uppercase except email/time/number/date */
document.addEventListener('input', e=>{
  const el = e.target;
  if(!el) return;
  if(el.tagName==='INPUT' || el.tagName==='TEXTAREA' || el.tagName==='SELECT'){
    if(el.type === 'email' || el.type === 'time' || el.type === 'number' || el.type === 'date') return;
    el.value = el.value.toUpperCase();
  }
});

/* Admin login */
function adminLogin(){
  const pw = document.getElementById('adminPass').value;
  if(pw === 'ADMIN123'){ adminAccess = true; alert('Admin access granted'); }
  else { alert('Incorrect password'); }
}

/* Render main faculty table and contingency preview table */
function renderTableFiltered(){
  const q = (document.getElementById('searchInput').value || '').trim().toUpperCase();
  const tbody = document.querySelector('#facultyTable tbody'); tbody.innerHTML = '';
  faculty.forEach((t,i)=>{
    const fullname = `${t.fname} ${t.mname} ${t.lname}`.trim();
    if(q && !(fullname.includes(q) || (t.position||'').includes(q) || (t.special||'').includes(q) || (t.empno||'').includes(q))) return;
    const tr = document.createElement('tr');
    tr.innerHTML = `
      <td>${i+1}</td>
      <td><strong>${fullname}</strong><br><small>${t.email || ''}</small></td>
      <td>${t.position}</td>
      <td>${t.empno}</td>
      <td>${t.special}</td>
      <td>${renderScheduleSummary(t.schedules)}</td>
      <td class="actions-cell">
        <button onclick="viewInfo(${i})">View Info</button>
        <button onclick="viewWeekly(${i})">View Schedule</button>
        <button onclick="openEdit(${i})">Edit</button>
        <button style="background:#e74c3c" onclick="deleteTeacher(${i})">Delete</button>
      </td>`;
    tbody.appendChild(tr);
  });
  renderContTable();
  populateContDropdown();
}

/* schedule summary helper */
function renderScheduleSummary(sched=[]){
  if(!sched || sched.length===0) return '<span class="pill">NO SCHEDULE</span>';
  return sched.slice(0,2).map(s => `<div class="pill">${s.day} ${s.start}-${s.end} ${s.subject} (${s.room})</div>`).join(' ');
}

/* Teacher functions (Add/Edit/Delete/View Info) */
function triggerAdd(){ if(!adminAccess){ alert('Please enter admin password first.'); return; } editingIndex = -1; openTeacherModal(); }
function openTeacherModal(){ document.getElementById('teacherModalTitle').innerText = editingIndex===-1 ? 'Add Teacher' : 'Edit Teacher'; clearTeacherForm(); document.getElementById('teacherModal').style.display='block'; }
function closeTeacherModal(){ document.getElementById('teacherModal').style.display='none'; editingIndex=-1; clearTeacherForm(); }
function clearTeacherForm(){ ['t_first','t_middle','t_last','t_position','t_empno','t_sex','t_age','t_contact','t_address','t_email','t_special'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value='';}); document.getElementById('scheduleList').innerHTML=''; ['s_day','s_start','s_end','s_subject','s_room'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); }
function addScheduleItem(){ const day=document.getElementById('s_day').value; const start=document.getElementById('s_start').value; const end=document.getElementById('s_end').value; const subject=(document.getElementById('s_subject').value||'').trim().toUpperCase(); const room=(document.getElementById('s_room').value||'').trim().toUpperCase(); if(!day||!start||!end||!subject||!room){ alert('Please complete schedule entry.'); return;} if(start>=end){ alert('Start must be before end.'); return;} const li=document.createElement('div'); li.className='schedule-item'; li.dataset.day=day; li.dataset.start=start; li.dataset.end=end; li.dataset.subject=subject; li.dataset.room=room; li.innerHTML=`<div>${day} ${start}-${end} ‚Ä¢ ${subject} ‚Ä¢ ${room}</div><div><button onclick="editScheduleItem(this)">‚úèÔ∏è</button> <button onclick="removeScheduleItem(this)">üóëÔ∏è</button></div>`; document.getElementById('scheduleList').appendChild(li); ['s_day','s_start','s_end','s_subject','s_room'].forEach(id=>{ const el=document.getElementById(id); if(el) el.value=''; }); }
function editScheduleItem(btn){ const el=btn.closest('.schedule-item'); if(!el) return; document.getElementById('s_day').value=el.dataset.day; document.getElementById('s_start').value=el.dataset.start; document.getElementById('s_end').value=el.dataset.end; document.getElementById('s_subject').value=el.dataset.subject; document.getElementById('s_room').value=el.dataset.room; el.remove(); }
function removeScheduleItem(btn){ const el=btn.closest('.schedule-item'); if(el) el.remove(); }

function saveTeacher(){
  const t = {
    fname:(document.getElementById('t_first').value||'').trim().toUpperCase(),
    mname:(document.getElementById('t_middle').value||'').trim().toUpperCase(),
    lname:(document.getElementById('t_last').value||'').trim().toUpperCase(),
    position:(document.getElementById('t_position').value||'').trim().toUpperCase(),
    empno:(document.getElementById('t_empno').value||'').trim().toUpperCase(),
    sex:(document.getElementById('t_sex').value||'').trim().toUpperCase(),
    age:(document.getElementById('t_age').value||'').trim(),
    contact:(document.getElementById('t_contact').value||'').trim().toUpperCase(),
    address:(document.getElementById('t_address').value||'').trim().toUpperCase(),
    email:(document.getElementById('t_email').value||'').trim(),
    special:(document.getElementById('t_special').value||'').trim().toUpperCase()
  };
  for(const k of ['fname','mname','lname','position','empno','sex','age','contact','address','email','special']){
    if(!t[k]){ alert('All fields (including Middle Name) are required.'); return; }
  }
  const schedEls = Array.from(document.querySelectorAll('#scheduleList .schedule-item'));
  if(schedEls.length === 0){ alert('At least one schedule entry is required.'); return; }
  t.schedules = schedEls.map(el => ({ day: el.dataset.day, start: el.dataset.start, end: el.dataset.end, subject: el.dataset.subject, room: el.dataset.room }));
  if(editingIndex >= 0){ faculty[editingIndex] = t; } else { faculty.push(t); }
  persist(); renderTableFiltered(); closeTeacherModal();
}

function openEdit(i){ if(!adminAccess){ alert('Admin required to edit'); return; } editingIndex = i; openTeacherModal(); const t = faculty[i]; document.getElementById('t_first').value=t.fname; document.getElementById('t_middle').value=t.mname; document.getElementById('t_last').value=t.lname; document.getElementById('t_position').value=t.position; document.getElementById('t_empno').value=t.empno; document.getElementById('t_sex').value=t.sex; document.getElementById('t_age').value=t.age; document.getElementById('t_contact').value=t.contact; document.getElementById('t_address').value=t.address; document.getElementById('t_email').value=t.email; document.getElementById('t_special').value=t.special; const list=document.getElementById('scheduleList'); list.innerHTML=''; (t.schedules||[]).forEach(s=>{ const li=document.createElement('div'); li.className='schedule-item'; li.dataset.day=s.day; li.dataset.start=s.start; li.dataset.end=s.end; li.dataset.subject=s.subject; li.dataset.room=s.room; li.innerHTML=`<div>${s.day} ${s.start}-${s.end} ‚Ä¢ ${s.subject} ‚Ä¢ ${s.room}</div><div><button onclick="editScheduleItem(this)">‚úèÔ∏è</button> <button onclick="removeScheduleItem(this)">üóëÔ∏è</button></div>`; list.appendChild(li); }); }

function deleteTeacher(i){ if(!adminAccess){ alert('Admin required to delete'); return; } if(!confirm('Delete this teacher?')) return; faculty.splice(i,1); persist(); renderTableFiltered(); }

function viewInfo(i){
  const t = faculty[i];
  const tbody = document.querySelector('#infoTable tbody'); tbody.innerHTML = '';
  const fields = [
    ['First Name', t.fname], ['Middle Name', t.mname], ['Last Name', t.lname],
    ['Position', t.position], ['Employee Number', t.empno], ['Sex', t.sex],
    ['Age', t.age], ['Address', t.address], ['Contact Number', t.contact],
    ['Email', t.email], ['Specialization', t.special]
  ];
  fields.forEach(f=>{
    const tr = document.createElement('tr'); tr.innerHTML = `<th style="width:35%;background:#fafafa">${f[0]}</th><td>${f[1]||''}</td>`; tbody.appendChild(tr);
  });
  document.getElementById('infoModal').style.display='block';
}
function closeInfoModal(){ document.getElementById('infoModal').style.display='none'; }

/* Weekly schedule view per teacher */
function viewWeekly(i){
  const t = faculty[i];
  document.getElementById('weekTitle').innerText = `Weekly Schedule ‚Äî ${t.fname} ${t.lname} (${t.empno})`;
  const weeks = ['MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY','SUNDAY'];
  // collect unique time boundaries from this teacher schedules
  const times = new Set();
  (t.schedules||[]).forEach(s=>{ times.add(s.start); times.add(s.end); });
  // if no schedules, show empty message
  if(times.size === 0){
    document.getElementById('weekContainer').innerHTML = '<div class="small">No schedule for this teacher.</div>';
    document.getElementById('weekModal').style.display='block';
    return;
  }
  const sortedTimes = Array.from(times).sort();
  // build contiguous rows from sortedTimes (start-end pairs)
  const rows = [];
  for(let i2=0;i2<sortedTimes.length-1;i2++){
    rows.push({start:sortedTimes[i2], end:sortedTimes[i2+1]});
  }
  // build table
  let html = '<table class="week-table"><thead><tr><th>Time</th>';
  weeks.forEach(d=> html += `<th>${d.slice(0,3)}</th>`);
  html += '</tr></thead><tbody>';
  rows.forEach(r=>{
    html += `<tr><th style="text-align:center">${r.start} - ${r.end}</th>`;
    weeks.forEach(day=>{
      // find classes of this teacher overlapping r.start-r.end on this day
      const classes = (t.schedules||[]).filter(s => s.day === day && ((s.start < r.end) && (s.end > r.start)));
      if(classes.length === 0) html += '<td></td>';
      else {
        html += '<td>' + classes.map(c => `<div class="class-block">${c.subject} ‚Ä¢ ${c.room}<br><small>${c.start}-${c.end}</small></div>`).join('') + '</td>';
      }
    });
    html += '</tr>';
  });
  html += '</tbody></table>';
  document.getElementById('weekContainer').innerHTML = html;
  document.getElementById('weekModal').style.display='block';
}
function closeWeekModal(){ document.getElementById('weekModal').style.display='none'; }

/* Vacant detection helpers */
function getCurrentDayTime(){ const now=new Date(); const days=['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY']; const day=days[now.getDay()]; const hh=String(now.getHours()).padStart(2,'0'); const mm=String(now.getMinutes()).padStart(2,'0'); const time=`${hh}:${mm}`; return {day,time}; }
function intervalsOverlap(startA, endA, startB, endB){ return (startA < endB) && (startB < endA); }
function getVacantAt(day, timeOrRange){ const result=[]; faculty.forEach(t=>{ const schedulesToday = (t.schedules||[]).filter(s => s.day === day); if(schedulesToday.length === 0){ result.push({t,reason:'No schedule on ' + day}); return; } let busy=false; if(timeOrRange.type==='point'){ busy = schedulesToday.some(s => (timeOrRange.time >= s.start && timeOrRange.time < s.end)); } else { busy = schedulesToday.some(s => intervalsOverlap(s.start, s.end, timeOrRange.start, timeOrRange.end)); } if(!busy) result.push({t,reason: timeOrRange.type==='point' ? `Free at ${timeOrRange.time}` : `Free during ${timeOrRange.start}-${timeOrRange.end}`}); }); return result; }

/* Vacant Now */
function openVacantModal(){ const list=document.getElementById('vacantListNow'); list.innerHTML=''; const ct=getCurrentDayTime(); const vacants=getVacantAt(ct.day, {type:'point', time:ct.time}); if(vacants.length===0) list.innerHTML='<div class="small">No vacant teachers at this time.</div>'; vacants.forEach(v=>{ const div=document.createElement('div'); div.className='schedule-item'; div.innerHTML=`<div><strong>${v.t.fname} ${v.t.lname}</strong><br><small>${v.t.position} ‚Ä¢ ${v.t.empno}</small><div class="small">${v.reason}</div></div><div><button onclick="openTeacherFromEmp('${v.t.empno}')">View</button></div>`; list.appendChild(div); }); document.getElementById('vacantModal').style.display='block'; }
function closeVacantModal(){ document.getElementById('vacantModal').style.display='none'; }
function openVacantChecker(){ document.getElementById('checker_day').value=''; document.getElementById('checker_time').value=''; document.getElementById('vacantCheckerResult').innerHTML=''; document.getElementById('vacantCheckerModal').style.display='block'; }
function closeVacantChecker(){ document.getElementById('vacantCheckerModal').style.display='none'; }
function runVacantChecker(){ const day=(document.getElementById('checker_day').value||'').trim().toUpperCase(); const time=(document.getElementById('checker_time').value||'').trim(); if(!day||!time){ alert('Please select day and time.'); return; } const listEl=document.getElementById('vacantCheckerResult'); listEl.innerHTML=''; const vacants=getVacantAt(day,{type:'point', time}); if(vacants.length===0) listEl.innerHTML='<div class="small">No vacant teachers at that day/time.</div>'; vacants.forEach(v=>{ const d=document.createElement('div'); d.className='schedule-item'; d.innerHTML=`<div><strong>${v.t.fname} ${v.t.lname}</strong><br><small>${v.t.position} ‚Ä¢ ${v.t.empno}</small><div class="small">${v.reason}</div></div><div><button onclick="openTeacherFromEmp('${v.t.empno}')">View</button></div>`; listEl.appendChild(d); }); }

/* Schedules list modal */
function openSchedulesModal(){ const el=document.getElementById('allSchedules'); el.innerHTML=''; if(faculty.length===0){ el.innerHTML='<div class="small">No teachers yet.</div>'; document.getElementById('schedulesModal').style.display='block'; return; } faculty.forEach(t=>{ const d=document.createElement('div'); d.className='schedule-item'; const schedText=(t.schedules||[]).map(s=> `${s.day} ${s.start}-${s.end} ‚Ä¢ ${s.subject} ‚Ä¢ ${s.room}`).join('<br>'); d.innerHTML=`<div><strong>${t.fname} ${t.lname}</strong><br><small>${t.position} ‚Ä¢ ${t.empno}</small><div class="small" style="margin-top:6px">${schedText || 'No schedule'}</div></div><div><button onclick="openTeacherFromEmp('${t.empno}')">View</button></div>`; el.appendChild(d); }); document.getElementById('schedulesModal').style.display='block'; }
function closeSchedulesModal(){ document.getElementById('schedulesModal').style.display='none'; }
function openTeacherFromEmp(empno){ const idx=faculty.findIndex(x=> x.empno===empno); if(idx>=0) viewInfo(idx); }

/* Contingency features */
function openContingencyModal(){ if(!adminAccess){ alert('Admin required to create contingency plans.'); return; } document.getElementById('cont_absent').innerHTML = '<option value="">Select Absent Teacher</option>'; faculty.forEach((t,i)=>{ const opt=document.createElement('option'); opt.value=t.empno; opt.text=`${t.fname} ${t.lname} ‚Äî ${t.empno}`; document.getElementById('cont_absent').appendChild(opt); }); document.getElementById('contCandidates').innerHTML=''; document.getElementById('cont_date').value=''; document.getElementById('cont_start').value=''; document.getElementById('cont_end').value=''; document.getElementById('cont_subject').value=''; document.getElementById('cont_room').value=''; document.getElementById('contModal').style.display='block'; }
function closeContingencyModal(){ document.getElementById('contModal').style.display='none'; }

function findSubstitutes(){
  const absentEmp = document.getElementById('cont_absent').value;
  const date = document.getElementById('cont_date').value;
  const start = document.getElementById('cont_start').value;
  const end = document.getElementById('cont_end').value;
  const subject = (document.getElementById('cont_subject').value||'').trim().toUpperCase();
  const room = (document.getElementById('cont_room').value||'').trim().toUpperCase();
  if(!absentEmp || !date || !start || !end || !subject || !room){ alert('Please complete all contingency fields.'); return; }
  if(start >= end){ alert('Start time must be before end time.'); return; }

  const d = new Date(date);
  const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  const day = days[d.getDay()];

  const candidates = getVacantAt(day, {type:'range', start, end}).filter(v=> v.t.empno !== absentEmp );
  const container = document.getElementById('contCandidates'); container.innerHTML = '';
  if(candidates.length===0){ container.innerHTML = '<div class="small">No available substitutes for that day/time.</div>'; return; }
  candidates.forEach(v=>{
    const el = document.createElement('div'); el.className='schedule-item';
    el.innerHTML = `<div><strong>${v.t.fname} ${v.t.lname}</strong><br><small>${v.t.position} ‚Ä¢ ${v.t.empno}</small><div class="small">${v.reason}</div></div>
      <div><button onclick="assignSubstitute('${absentEmp}','${v.t.empno}','${date}','${start}','${end}','${subject}','${room}')">Assign</button></div>`;
    container.appendChild(el);
  });
}

function assignSubstitute(absentEmp, subEmp, date, start, end, subject, room){
  const absent = faculty.find(f=> f.empno === absentEmp);
  const sub = faculty.find(f=> f.empno === subEmp);
  if(!absent || !sub){ alert('Teacher not found'); return; }
  const plan = {
    id: Date.now(),
    absentEmp, absentName:`${absent.fname} ${absent.lname}`,
    subEmp, subName:`${sub.fname} ${sub.lname}`,
    subject, room, date, start, end,
    created: new Date().toISOString()
  };
  contingency.unshift(plan);
  persistCont();
  renderContTable();
  alert(`Assigned ${plan.subName} as substitute for ${plan.absentName} on ${plan.date} ${plan.start}-${plan.end}`);
  document.getElementById('contCandidates').innerHTML = '';
}

/* Contingency list rendering */
function openContingencyList(){ renderContTable(); document.getElementById('contListModal').style.display='block'; }
function closeContingencyList(){ document.getElementById('contListModal').style.display='none'; }
function renderContTable(){
  const tbody = document.querySelector('#contTable tbody'); if(!tbody) return;
  tbody.innerHTML = '';
  contingency.slice(0,10).forEach((c,i)=>{ const tr=document.createElement('tr'); tr.innerHTML = `<td>${i+1}</td><td>${c.absentName}</td><td>${c.subName}</td><td>${c.subject}</td><td>${c.room}</td><td>${c.date}</td><td>${c.start}-${c.end}</td>`; tbody.appendChild(tr); });
  const list = document.getElementById('contList'); if(list) { list.innerHTML=''; if(contingency.length===0) list.innerHTML='<div class="small">No contingency plans saved.</div>'; contingency.forEach((c,idx)=>{ const el=document.createElement('div'); el.className='schedule-item'; el.innerHTML = `<div><strong>${c.absentName}</strong><br><small>Sub: ${c.subName} ‚Ä¢ ${c.date} ${c.start}-${c.end}</small><div class="small">Subject: ${c.subject} ‚Ä¢ Room: ${c.room}</div></div><div><button onclick="removeContingency(${idx})">Delete</button></div>`; list.appendChild(el); }); }
}
function removeContingency(idx){ if(!adminAccess){ alert('Admin required'); return;} if(!confirm('Delete this contingency plan?')) return; contingency.splice(idx,1); persistCont(); renderContTable(); }

function exportContingencyCSV(){
  if(contingency.length===0){ alert('No contingency plans'); return; }
  const rows=[['#','ABSENT_NAME','ABSENT_EMP','SUB_NAME','SUB_EMP','SUBJECT','ROOM','DATE','START','END','CREATED']];
  contingency.forEach((c,i)=> rows.push([i+1,c.absentName,c.absentEmp,c.subName,c.subEmp,c.subject,c.room,c.date,c.start,c.end,c.created]));
  const csv = rows.map(r=> r.map(c=> `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob(['\ufeff', csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`contingency_plans_${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* Export faculty CSV */
function exportCSV(){ if(faculty.length===0){ alert('No data to export'); return; } const rows=[]; const header=['#','FIRST','MIDDLE','LAST','POSITION','EMP_NO','SEX','AGE','ADDRESS','CONTACT','EMAIL','SPECIAL','SCHEDULES_JSON']; rows.push(header); faculty.forEach((t,i)=>{ const schedulesJson = JSON.stringify(t.schedules || []); rows.push([i+1,t.fname,t.mname,t.lname,t.position,t.empno,t.sex,t.age,t.address,t.contact,t.email,t.special,schedulesJson]); }); const csv = rows.map(r => r.map(c => `"${String(c||'').replace(/"/g,'""')}"`).join(',')).join('\r\n'); const blob = new Blob(['\ufeff', csv], {type:'text/csv;charset=utf-8;'}); const url=URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`faculty_data_${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(url); }

/* utility open/close modal behaviors */
document.querySelectorAll('.modal').forEach(m=> m.addEventListener('click', e=> { if(e.target === m) m.style.display='none'; }));
document.addEventListener('keydown', e=> { if(e.key === 'Escape') document.querySelectorAll('.modal').forEach(m=> m.style.display='none'); });

/* Clear all data (admin only) */
function clearAllData(){ if(!adminAccess){ alert('Admin required'); return; } if(!confirm('Erase ALL saved data? This cannot be undone.')) return; faculty=[]; contingency=[]; persist(); persistCont(); renderTableFiltered(); }

/* initial render */
renderTableFiltered();
if(!localStorage.getItem(STORAGE_KEY)) persist();
if(!localStorage.getItem(CONT_KEY)) persistCont();
</script>
  <!-- ‚úÖ Excel Import Feature (SheetJS) -->
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>

<script>
<input type="file" id="excelFile" accept=".xlsx,.csv" onchange="importDataFromExcel(event)" />

<script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>

<script>
function importDataFromExcel(event){
  const file = event.target.files[0];
  if(!file){ alert('Please select a file'); return; }

  const reader = new FileReader();
  reader.onload = function(e){
    try {
      const data = new Uint8Array(e.target.result);
      const workbook = XLSX.read(data, {type:'array'});
      const sheetName = workbook.SheetNames[0];
      const worksheet = workbook.Sheets[sheetName];
      const jsonData = XLSX.utils.sheet_to_json(worksheet, {defval:''});

      let importedCount = 0;
      jsonData.forEach(row => {
        const t = {
          fname: row['First Name'] || row['FIRST NAME'] || row['Firstname'] || '',
          mname: row['Middle Name'] || row['MIDDLE NAME'] || '',
          lname: row['Last Name'] || row['LAST NAME'] || '',
          position: row['Position'] || row['POSITION'] || '',
          empno: row['Employee No'] || row['EMP NO'] || '',
          sex: row['Sex'] || row['Gender'] || '',
          age: row['Age'] || '',
          address: row['Address'] || '',
          contact: row['Contact'] || '',
          email: row['Email'] || '',
          special: row['Specialization'] || row['Special'] || '',
          schedules: []
        };
        if(t.fname || t.lname){
          faculty.push(t);
          importedCount++;
        }
      });

      persist();
      renderTableFiltered();
      alert(importedCount + " teacher(s) imported successfully!");
    } catch(err){
      alert("Error reading file: " + err.message);
    }
  };
  reader.readAsArrayBuffer(file);
  event.target.value = '';
  // Fix for missing function after import
function populateContDropdown(){
  // This function refreshes dropdowns (if any)
  // If your system doesn‚Äôt use dropdowns, this just does nothing safely.
  console.log('populateContDropdown() was called ‚Äî no action needed.');
}

}
</script>


</script>

</body>
</html>











