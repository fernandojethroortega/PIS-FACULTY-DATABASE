<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pagudpud Integrated School - Faculty Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root { --blue:#0d3b66; --gold:#ffb703; --bg:#fff8e7; }
body { font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; margin:0; background:var(--bg); }
header { background:var(--blue); color:#fff; padding:15px 20px; text-align:center; font-size:1.4rem; position:relative; }
#clock { position:absolute; top:8px; left:15px; font-size:0.9rem; }
main { padding:20px; }
.search-bar { margin-bottom:20px; text-align:center; }
input[type="text"], input[type="time"] { padding:8px; width:200px; border-radius:6px; border:1px solid #ccc; margin:4px; }
.teacher-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(250px,1fr)); gap:15px; }
.teacher-card { background:#fff; border-radius:12px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
.teacher-photo { width:100px; height:100px; object-fit:cover; border-radius:50%; border:3px solid var(--gold); margin-bottom:10px; }
.teacher-name { font-weight:bold; color:var(--blue); font-size:1.05rem; }
.teacher-info { font-size:0.9rem; color:#333; margin-top:6px; }
button { background:var(--blue); color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; margin:3px; }
button:hover { background:var(--gold); color:var(--blue); }
.modal { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20; overflow:auto; }
.modal-content { background:#fff; margin:5% auto; padding:20px; width:650px; border-radius:10px; }
.close { float:right; color:red; cursor:pointer; font-size:1.2rem; }
table { border-collapse:collapse; width:100%; margin-top:10px; }
th, td { padding:6px 8px; text-align:left; border:1px solid #ccc; font-size:0.9rem; }
th { background:var(--blue); color:#fff; }
.add-sched-form { display:flex; flex-wrap:wrap; justify-content:center; gap:5px; margin-top:10px; }
</style>
</head>
<body>

<header>
  <div id="clock"></div>
  PAGUDPUD INTEGRATED SCHOOL â€” FACULTY DASHBOARD
</header>

<main>
  <div class="search-bar">
    <input id="searchInput" type="text" placeholder="Search teacher..." oninput="searchTeacher()">
  </div>
  <div id="teacherContainer" class="teacher-grid"></div>
</main>

<!-- View Teacher Modal -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Teacher Information</h3>
    <p><strong>Full Name:</strong> <span id="vFullName"></span></p>
    <p><strong>Position:</strong> <span id="vPosition"></span></p>
    <p><strong>Employee No.:</strong> <span id="vEmpNo"></span></p>
    <p><strong>Sex:</strong> <span id="vSex"></span></p>
    <p><strong>Age:</strong> <span id="vAge"></span></p>
    <p><strong>Address:</strong> <span id="vAddress"></span></p>
    <p><strong>Specialization:</strong> <span id="vSpec"></span></p>
    <p><strong>Email:</strong> <span id="vEmail"></span></p>
    <p><strong>Contact No.:</strong> <span id="vContact"></span></p>
  </div>
</div>

<!-- View Schedule Modal -->
<div id="scheduleModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeScheduleModal()">&times;</span>
    <h3>Schedule for <span id="scheduleTeacherName"></span></h3>

    <!-- Add Schedule Form -->
    <div class="add-sched-form">
      <input type="text" id="dayInput" placeholder="Day">
      <input type="text" id="subjectInput" placeholder="Subject">
      <input type="time" id="startInput" placeholder="Start Time">
      <input type="time" id="endInput" placeholder="End Time">
      <input type="text" id="gradeInput" placeholder="Grade & Section">
      <input type="text" id="roomInput" placeholder="Room">
      <button onclick="addManualSchedule()">Add Schedule</button>
    </div>

    <table id="scheduleTable">
      <thead>
        <tr>
          <th>DAY</th>
          <th>SUBJECT</th>
          <th>START TIME</th>
          <th>END TIME</th>
          <th>GRADE LEVEL & SECTION</th>
          <th>ROOM</th>
          <th>ACTION</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* Clock */
function updateClock(){ document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
setInterval(updateClock,1000); updateClock();

/* Helpers */
function normalizeHeader(h){ return String(h||'').trim().toLowerCase(); }
function sanitizeKey(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,'_'); }
function genIdFromName(first,last,middle){ 
  const f=(first||'').trim().toLowerCase();
  const l=(last||'').trim().toLowerCase();
  const m=(middle||'').trim().toLowerCase().charAt(0)||'';
  return sanitizeKey(`${f}_${m}_${l}`)||('id_'+Math.random().toString(36).slice(2,9));
}

/* Storage */
let savedPhotos={}, savedSchedules={};
try{ savedPhotos=JSON.parse(localStorage.getItem('teacherPhotos')||'{}'); }catch(e){}
try{ savedSchedules=JSON.parse(localStorage.getItem('teacherSchedules')||'{}'); }catch(e){}
let teacherData=[]; let currentTeacherId=null;

/* Load Teacher Data */
async function loadTeacherData(){
  const fileUrl="https://docs.google.com/spreadsheets/d/1FJl1WywegQhwYHdAv_nf4ZmNrEI63sJfdP_83lD8lfk/export?format=csv";
  try{
    const res=await fetch(fileUrl);
    const csv=await res.text();
    const wb=XLSX.read(csv,{type:'string'});
    const sheet=wb.Sheets[wb.SheetNames[0]];
    const raw=XLSX.utils.sheet_to_json(sheet,{defval:''});
    teacherData=raw.map(row=>{
      const norm={}; for(const k in row) norm[normalizeHeader(k)]=row[k];
      const empNo=(norm['employee number']||norm['emp no']||'').toString().trim();
      const id=empNo?sanitizeKey(empNo):genIdFromName(norm['first name'],norm['last name'],norm['middle name']);
      const photo=savedPhotos[id]||'';
      const schedule=savedSchedules[id]||[];
      return {id,empNo,row:norm,photo,schedule};
    });
    renderCards(teacherData);
  }catch(e){console.error(e); alert("Failed to load data");}
}

/* Render Cards */
function renderCards(list){
  const container=document.getElementById('teacherContainer');
  container.innerHTML='';
  list.forEach(item=>{
    const r=item.row;
    const name=`${r['first name']||''} ${r['middle name']?r['middle name'].charAt(0)+'.':''} ${r['last name']||''}`.trim();
    const photo=item.photo||'https://via.placeholder.com/100?text=No+Photo';
    const card=document.createElement('div');
    card.className='teacher-card';
    card.innerHTML=`
      <img src="${photo}" class="teacher-photo" id="photo_${item.id}">
      <div class="teacher-name">${name}</div>
      <div class="teacher-info">
        <div>${r['position']||''}</div>
        <div>${r['email']||''}</div>
        <div>${r['contact number']||r['contact']||''}</div>
      </div>
      <button onclick="viewTeacher('${item.id}')">View</button>
      <button onclick="viewSchedule('${item.id}')">View Schedule</button>
      <button onclick="triggerUpload('${item.id}')">Upload Photo</button>
      <input type="file" accept="image/*" id="file_${item.id}" style="display:none">
    `;
    container.appendChild(card);
    document.getElementById(`file_${item.id}`).onchange=(e)=>previewPhoto(e,item.id);
  });
}

/* Photo */
function triggerUpload(id){ document.getElementById(`file_${id}`).click(); }
function previewPhoto(e,id){
  const file=e.target.files[0]; if(!file)return;
  const r=new FileReader();
  r.onload=a=>{
    const data=a.target.result;
    document.getElementById(`photo_${id}`).src=data;
    savedPhotos[id]=data;
    localStorage.setItem('teacherPhotos',JSON.stringify(savedPhotos));
  };
  r.readAsDataURL(file);
}

/* View Teacher */
function viewTeacher(id){
  const t=teacherData.find(x=>x.id===id);
  const r=t.row;
  document.getElementById('vFullName').textContent=`${r['first name']} ${r['middle name']||''} ${r['last name']}`;
  document.getElementById('vPosition').textContent=r['position']||'';
  document.getElementById('vEmpNo').textContent=t.empNo||'';
  document.getElementById('vSex').textContent=r['sex']||'';
  document.getElementById('vAge').textContent=r['age']||'';
  document.getElementById('vAddress').textContent=r['address']||'';
  document.getElementById('vSpec').textContent=r['specialization']||'';
  document.getElementById('vEmail').textContent=r['email']||'';
  document.getElementById('vContact').textContent=r['contact number']||r['contact']||'';
  document.getElementById('viewModal').style.display='block';
}
function closeModal(){ document.getElementById('viewModal').style.display='none'; }

/* Schedule Modal */
function viewSchedule(id){
  currentTeacherId=id;
  const t=teacherData.find(x=>x.id===id);
  document.getElementById('scheduleTeacherName').textContent=
    `${t.row['first name']} ${t.row['middle name']?t.row['middle name'].charAt(0)+'.':''} ${t.row['last name']}`;
  renderScheduleTable(t.schedule);
  document.getElementById('scheduleModal').style.display='block';
}
function closeScheduleModal(){ document.getElementById('scheduleModal').style.display='none'; }

/* Add Schedule */
function addManualSchedule(){
  if(!currentTeacherId)return;
  const t=teacherData.find(x=>x.id===currentTeacherId);
  const newEntry={
    DAY:document.getElementById('dayInput').value.trim(),
    SUBJECT:document.getElementById('subjectInput').value.trim(),
    'START TIME':document.getElementById('startInput').value,
    'END TIME':document.getElementById('endInput').value,
    'GRADE LEVEL & SECTION':document.getElementById('gradeInput').value.trim(),
    ROOM:document.getElementById('roomInput').value.trim()
  };
  if(!newEntry.DAY||!newEntry.SUBJECT) return alert("Please fill at least Day and Subject.");
  t.schedule.push(newEntry);
  saveSchedule(t.id,t.schedule);
  renderScheduleTable(t.schedule);
  document.querySelectorAll('.add-sched-form input').forEach(i=>i.value='');
}

/* Save Schedules */
function saveSchedule(id,sched){
  savedSchedules[id]=sched;
  localStorage.setItem('teacherSchedules',JSON.stringify(savedSchedules));
}

/* Edit/Delete */
function editSchedule(i){
  const t=teacherData.find(x=>x.id===currentTeacherId);
  const s=t.schedule[i];
  const newDay=prompt("Edit Day:",s.DAY);
  const newSub=prompt("Edit Subject:",s.SUBJECT);
  const newStart=prompt("Edit Start Time:",s["START TIME"]);
  const newEnd=prompt("Edit End Time:",s["END TIME"]);
  const newGrade=prompt("Edit Grade & Section:",s["GRADE LEVEL & SECTION"]);
  const newRoom=prompt("Edit Room:",s.ROOM);
  if(newDay!==null)s.DAY=newDay;
  if(newSub!==null)s.SUBJECT=newSub;
  if(newStart!==null)s["START TIME"]=newStart;
  if(newEnd!==null)s["END TIME"]=newEnd;
  if(newGrade!==null)s["GRADE LEVEL & SECTION"]=newGrade;
  if(newRoom!==null)s.ROOM=newRoom;
  saveSchedule(currentTeacherId,t.schedule);
  renderScheduleTable(t.schedule);
}
function deleteSchedule(i){
  if(!confirm("Delete this schedule entry?"))return;
  const t=teacherData.find(x=>x.id===currentTeacherId);
  t.schedule.splice(i,1);
  saveSchedule(t.id,t.schedule);
  renderScheduleTable(t.schedule);
}

/* Render Schedule Table */
function renderScheduleTable(rows){
  const tbody=document.querySelector('#scheduleTable tbody');
  tbody.innerHTML='';
  rows.forEach((r,i)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r.DAY}</td>
      <td>${r.SUBJECT}</td>
      <td>${r["START TIME"]}</td>
      <td>${r["END TIME"]}</td>
      <td>${r["GRADE LEVEL & SECTION"]}</td>
      <td>${r.ROOM}</td>
      <td><button onclick="editSchedule(${i})">Edit</button><button onclick="deleteSchedule(${i})">Delete</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* Search */
function searchTeacher(){
  const q=(document.getElementById('searchInput').value||'').toLowerCase().trim();
  const filtered=!q?teacherData:teacherData.filter(t=>Object.values(t.row).join(' ').toLowerCase().includes(q));
  renderCards(filtered);
}

/* Init */
loadTeacherData();
</script>

</body>
</html>
