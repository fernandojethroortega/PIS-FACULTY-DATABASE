<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width, initial-scale=1" />
<title>Pagudpud Integrated School - Faculty Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/xlsx@0.18.5/dist/xlsx.full.min.js"></script>
<style>
:root { --blue:#0d3b66; --gold:#ffb703; --bg:#fff8e7; }
body { font-family:"Segoe UI", Tahoma, Geneva, Verdana, sans-serif; margin:0; background:var(--bg); }
header { background:var(--blue); color:#fff; padding:15px 20px; text-align:center; font-size:1.4rem; position:relative; }
#clock { position:absolute; top:8px; left:15px; font-size:0.9rem; }
main { padding:20px; }
.search-bar { margin-bottom:20px; text-align:center; }
input[type="text"], input[type="date"], input[type="time"] { padding:10px; border-radius:8px; border:1px solid #ccc; margin:5px; }
.teacher-grid { display:grid; grid-template-columns:repeat(auto-fill, minmax(250px,1fr)); gap:15px; }
.teacher-card { background:#fff; border-radius:12px; padding:15px; box-shadow:0 2px 6px rgba(0,0,0,0.1); text-align:center; }
.teacher-photo { width:100px; height:100px; object-fit:cover; border-radius:50%; border:3px solid var(--gold); margin-bottom:10px; }
.teacher-name { font-weight:bold; color:var(--blue); font-size:1.05rem; }
.teacher-info { font-size:0.9rem; color:#333; margin-top:6px; }
button { background:var(--blue); color:#fff; border:none; padding:6px 12px; border-radius:6px; cursor:pointer; margin:3px; }
button:hover { background:var(--gold); color:var(--blue); }
.modal { display:none; position:fixed; left:0; top:0; width:100%; height:100%; background:rgba(0,0,0,0.5); z-index:20; overflow:auto; }
.modal-content { background:#fff; margin:6% auto; padding:20px; width:420px; border-radius:10px; }
.close { float:right; color:red; cursor:pointer; font-size:1.2rem; }
table { border-collapse:collapse; width:100%; }
th, td { padding:6px 8px; text-align:left; border:1px solid #ccc; font-size:0.9rem; }
th { background:var(--blue); color:#fff; }
</style>
</head>
<body>

<header>
  <div id="clock"></div>
  PAGUDPUD INTEGRATED SCHOOL â€” FACULTY DASHBOARD
</header>

<main>
  <!-- Search -->
  <div class="search-bar">
    <input id="searchInput" type="text" placeholder="Search teacher..." oninput="searchTeacher()">
  </div>

  <!-- Vacant Check -->
  <div class="search-bar">
    <input type="date" id="checkDate">
    <input type="time" id="checkTime">
    <button onclick="checkVacantTeachers()">Check Vacant Teachers</button>
    <button onclick="checkVacantNow()">Check Vacant Now</button>
  </div>

  <!-- Vacant Teachers Container -->
  <div id="vacantContainer" class="teacher-grid"></div>

  <!-- All Teachers Container -->
  <div id="teacherContainer" class="teacher-grid"></div>
</main>

<!-- View Teacher Modal -->
<div id="viewModal" class="modal">
  <div class="modal-content">
    <span class="close" onclick="closeModal()">&times;</span>
    <h3>Teacher Information</h3>
    <p><strong>Full Name:</strong> <span id="vFullName"></span></p>
    <p><strong>Position:</strong> <span id="vPosition"></span></p>
    <p><strong>Employee No.:</strong> <span id="vEmpNo"></span></p>
    <p><strong>Sex:</strong> <span id="vSex"></span></p>
    <p><strong>Age:</strong> <span id="vAge"></span></p>
    <p><strong>Address:</strong> <span id="vAddress"></span></p>
    <p><strong>Specialization:</strong> <span id="vSpec"></span></p>
    <p><strong>Email:</strong> <span id="vEmail"></span></p>
    <p><strong>Contact No.:</strong> <span id="vContact"></span></p>
  </div>
</div>

<!-- View Schedule Modal -->
<div id="scheduleModal" class="modal">
  <div class="modal-content" style="width:650px;">
    <span class="close" onclick="closeScheduleModal()">&times;</span>
    <h3>Schedule for <span id="scheduleTeacherName"></span></h3>
    <table id="scheduleTable">
      <thead>
        <tr>
          <th>DAY</th>
          <th>SUBJECT</th>
          <th>START TIME</th>
          <th>END TIME</th>
          <th>GRADE LEVEL & SECTION</th>
          <th>ROOM</th>
        </tr>
      </thead>
      <tbody></tbody>
    </table>
  </div>
</div>

<script>
/* Clock */
function updateClock(){ document.getElementById('clock').textContent = new Date().toLocaleTimeString(); }
setInterval(updateClock,1000); updateClock();

/* Utilities */
function normalizeHeader(h){ return String(h||'').trim().toLowerCase(); }
function sanitizeKey(s){ return String(s||'').trim().toLowerCase().replace(/\s+/g,'_'); }
function genIdFromName(first,last,middle){ 
  const f = (first||'').trim().toLowerCase();
  const l = (last||'').trim().toLowerCase();
  const m = (middle||'').trim().toLowerCase().charAt(0) || '';
  return sanitizeKey(`${f}_${m}_${l}`) || ('id_' + Math.random().toString(36).slice(2,9));
}

/* Storage */
let savedPhotos = {};
let savedSchedules = {};
try { savedPhotos = JSON.parse(localStorage.getItem('teacherPhotos')||'{}'); } catch(e){ savedPhotos={}; }
try { savedSchedules = JSON.parse(localStorage.getItem('teacherSchedules')||'{}'); } catch(e){ savedSchedules={}; }

let teacherData = [];

/* Load Teacher CSV */
async function loadTeacherData(){
  const fileUrl = "https://docs.google.com/spreadsheets/d/1FJl1WywegQhwYHdAv_nf4ZmNrEI63sJfdP_83lD8lfk/export?format=csv";
  try {
    const res = await fetch(fileUrl);
    if(!res.ok) throw new Error('fetch failed: ' + res.status);
    const csv = await res.text();
    const wb = XLSX.read(csv, {type:'string'});
    const sheet = wb.Sheets[wb.SheetNames[0]];
    let raw = XLSX.utils.sheet_to_json(sheet, {defval:''});
    
    teacherData = raw.map(row=>{
      const normRow={};
      for(const k in row) normRow[normalizeHeader(k)] = row[k];
      const empNo = (normRow['employee number']||normRow['emp no']||normRow['employee_no']||'').toString().trim();
      const id = empNo ? sanitizeKey(empNo) : genIdFromName(normRow['first name'], normRow['last name'], normRow['middle name']);
      const photo = savedPhotos[id] || savedPhotos[empNo] || savedPhotos[sanitizeKey(normRow['first name']+'_'+normRow['last name'])] || '';
      const schedule = savedSchedules[id] || [];
      return {id, empNo, row: normRow, photo: photo||'', schedule};
    });
    renderCards(teacherData);
  } catch(err){ console.error(err); alert('Failed to load sheet. See console for details.'); }
}

/* Render Cards */
function renderCards(list,containerId='teacherContainer'){
  const container = document.getElementById(containerId);
  container.innerHTML = '';
  list.forEach(item=>{
    const r=item.row;
    const middleInitial = r['middle name'] ? r['middle name'].charAt(0).toUpperCase()+'.' : '';
    const fullName = `${r['first name']||''} ${middleInitial} ${r['last name']||''}`.trim();
    const photoSrc = item.photo || 'https://via.placeholder.com/100?text=No+Photo';
    const card = document.createElement('div');
    card.className='teacher-card';
    card.innerHTML = `
      <img src="${photoSrc}" alt="photo" class="teacher-photo" id="photo_${item.id}">
      <div class="teacher-name">${fullName}</div>
      <div class="teacher-info">
        <div>${r['position']||''}</div>
        <div style="font-size:0.85rem;color:#555">${r['email']||''}</div>
        <div style="font-size:0.85rem;color:#555">${r['contact number']||r['contact']||''}</div>
      </div>
      <button onclick="viewTeacher('${item.id}')">View</button>
      <button onclick="viewSchedule('${item.id}')">View Schedule</button>
      <button onclick="triggerUpload('${item.id}')">Upload Photo</button>
      <input type="file" accept="image/*" style="display:none" id="file_${item.id}">
      <button onclick="triggerScheduleUpload('${item.id}')">Import Schedule</button>
      <input type="file" accept=".csv, application/vnd.ms-excel, application/vnd.openxmlformats-officedocument.spreadsheetml.sheet" style="display:none" id="scheduleFile_${item.id}">
    `;
    container.appendChild(card);
    document.getElementById(`file_${item.id}`).onchange=(e)=>previewPhoto(e,item.id);
    document.getElementById(`scheduleFile_${item.id}`).onchange=(e)=>handleScheduleUpload(e,item.id);
  });
}

/* Photo upload */
function triggerUpload(empId){ document.getElementById(`file_${empId}`).click(); }
function previewPhoto(evt,empId){
  const file=evt.target.files[0];
  if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    const dataUrl=e.target.result;
    const img=document.getElementById(`photo_${empId}`);
    if(img) img.src=dataUrl;
    savedPhotos[empId]=dataUrl;
    try{ localStorage.setItem('teacherPhotos',JSON.stringify(savedPhotos)); } catch(err){ console.error(err); }
    const t=teacherData.find(x=>x.id===empId);
    if(t) t.photo=dataUrl;
  };
  reader.readAsDataURL(file);
}

/* Time parsing */
function parseTimeToMinutes(timeStr){
  if(!timeStr) return NaN;
  timeStr = timeStr.toString().trim().toUpperCase();
  let h=0, m=0;
  if(timeStr.includes('AM') || timeStr.includes('PM')){
    const match = timeStr.match(/(\d{1,2}):(\d{2})\s*(AM|PM)/i);
    if(!match) return NaN;
    h=parseInt(match[1]); m=parseInt(match[2]);
    const period = match[3];
    if(period==='PM' && h!==12) h+=12;
    if(period==='AM' && h===12) h=0;
  } else {
    const parts=timeStr.split(':');
    if(parts.length!==2) return NaN;
    h=parseInt(parts[0]); m=parseInt(parts[1]);
  }
  return h*60+m;
}

/* Handle Schedule Import */
function triggerScheduleUpload(empId){ document.getElementById(`scheduleFile_${empId}`).click(); }
function handleScheduleUpload(evt,empId){
  const file=evt.target.files[0]; if(!file) return;
  const reader=new FileReader();
  reader.onload=e=>{
    let data=e.target.result;
    let wb;
    try{
      if(file.name.endsWith('.csv')) wb=XLSX.read(data,{type:'binary'});
      else wb=XLSX.read(data,{type:'array'});
    }catch(err){ alert('Failed to read file: '+err.message); return; }

    const sheet=wb.Sheets[wb.SheetNames[0]];
    const scheduleRows=XLSX.utils.sheet_to_json(sheet,{defval:''});
    const normalized = scheduleRows.map(r=>{
      const day = (r['DAY']||r['Day']||'').toLowerCase();
      const start = parseTimeToMinutes(r['START TIME']||r['Start Time']);
      const end = parseTimeToMinutes(r['END TIME']||r['End Time']);
      return {...r, day, start, end};
    });

    const t = teacherData.find(x=>x.id===empId);
    if(t){
      t.schedule = normalized;
      savedSchedules[empId]=normalized;
      try{ localStorage.setItem('teacherSchedules',JSON.stringify(savedSchedules)); } catch(err){ console.error(err); }
    }
    alert('Schedule imported successfully. Click "View Schedule" to see it.');
  };
  if(file.name.endsWith('.csv')) reader.readAsBinaryString(file);
  else reader.readAsArrayBuffer(file);
}

/* View Teacher */
function viewTeacher(empId){
  const t=teacherData.find(x=>x.id===empId);
  if(!t) return alert('Teacher not found');
  const r=t.row;
  const middleInitial=r['middle name']?r['middle name'].charAt(0)+'.':'';
  document.getElementById('vFullName').textContent=`${r['first name']||''} ${middleInitial} ${r['last name']||''}`.trim();
  document.getElementById('vPosition').textContent=r['position']||'';
  document.getElementById('vEmpNo').textContent=t.empNo||'';
  document.getElementById('vSex').textContent=r['sex']||'';
  document.getElementById('vAge').textContent=r['age']||'';
  document.getElementById('vAddress').textContent=r['address']||'';
  document.getElementById('vSpec').textContent=r['specialization']||'';
  document.getElementById('vEmail').textContent=r['email']||'';
  document.getElementById('vContact').textContent=r['contact number']||r['contact']||'';
  document.getElementById('viewModal').style.display='block';
}
function closeModal(){ document.getElementById('viewModal').style.display='none'; }

/* View Schedule */
function viewSchedule(empId){
  const t=teacherData.find(x=>x.id===empId);
  if(!t) return alert('Teacher not found');
  const fullName=`${t.row['first name']||''} ${t.row['middle name']?t.row['middle name'].charAt(0)+'.':''} ${t.row['last name']||''}`.trim();
  const rows=t.schedule||[];
  if(rows.length===0) return alert('No schedule imported yet. Please import your schedule file.');

  const tbody=document.querySelector('#scheduleTable tbody');
  tbody.innerHTML='';
  rows.forEach(r=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${r['DAY']||r['Day']||''}</td>
      <td>${r['SUBJECT']||r['Subject']||''}</td>
      <td>${r['START TIME']||r['Start Time']||''}</td>
      <td>${r['END TIME']||r['End Time']||''}</td>
      <td>${r['GRADE LEVEL & SECTION']||r['Grade Level & Section']||r['Grade & Section']||''}</td>
      <td>${r['ROOM']||r['Room']||''}</td>
    `;
    tbody.appendChild(tr);
  });

  document.getElementById('scheduleTeacherName').textContent=fullName;
  document.getElementById('scheduleModal').style.display='block';
}
function closeScheduleModal(){ document.getElementById('scheduleModal').style.display='none'; }

/* Search */
function searchTeacher(){
  const q=(document.getElementById('searchInput').value||'').toLowerCase().trim();
  if(!q){ renderCards(teacherData); return; }
  const filtered=teacherData.filter(t=>Object.values(t.row).join(' ').toLowerCase().includes(q));
  renderCards(filtered);
}

/* Check Vacant Teachers by date/time */
function checkVacantTeachers(){
  const dateStr = document.getElementById('checkDate').value;
  const timeStr = document.getElementById('checkTime').value;
  if(!dateStr || !timeStr) return alert('Please select both date and time.');
  const dayName = new Date(dateStr).toLocaleDateString('en-US',{weekday:'long'}).toLowerCase();
  const [selHour,selMin]=timeStr.split(':').map(Number);
  const selectedMinutes = selHour*60+selMin;

  const vacant = teacherData.filter(t=>{
    if(!t.schedule || t.schedule.length===0) return true;
    return !t.schedule.some(r=>{
      if(r.day!==dayName) return false;
      return selectedMinutes>=r.start && selectedMinutes<r.end;
    });
  });

  renderCards(vacant,'vacantContainer');
  if(vacant.length===0) document.getElementById('vacantContainer').innerHTML='<p>No teachers are vacant at this time.</p>';
}

/* Check Vacant Now */
function checkVacantNow(){
  const now = new Date();
  const dayName = now.toLocaleDateString('en-US',{weekday:'long'}).toLowerCase();
  const currentMinutes = now.getHours()*60 + now.getMinutes();

  const vacant = teacherData.filter(t=>{
    if(!t.schedule || t.schedule.length===0) return true;
    return !t.schedule.some(r=>{
      if(r.day!==dayName) return false;
      return currentMinutes>=r.start && currentMinutes<r.end;
    });
  });

  renderCards(vacant,'vacantContainer');
  if(vacant.length===0) document.getElementById('vacantContainer').innerHTML='<p>No teachers are vacant right now.</p>';
}

/* Init */
loadTeacherData();
</script>

</body>
</html>
