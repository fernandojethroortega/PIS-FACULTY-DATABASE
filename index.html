<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Contingency Planner — Pagudpud Integrated School</title>
<style>
  :root{--blue:#0d3b66;--gold:#ffb703;--bg:#fff8e7}
  body{font-family:Segoe UI, Tahoma, Geneva, Verdana,sans-serif;background:var(--bg);margin:0;color:#111;padding:18px}
  header{display:flex;align-items:center;justify-content:space-between;background:var(--gold);color:var(--blue);padding:12px 16px;border-radius:8px;box-shadow:0 3px 6px rgba(0,0,0,.12);margin-bottom:18px}
  header h1{font-size:16px;margin:0}
  .controls{display:flex;gap:8px;align-items:center}
  .card{background:#fff;border-radius:8px;padding:12px;box-shadow:0 3px 8px rgba(0,0,0,.06);margin-bottom:12px}
  label{display:block;font-size:13px;margin-bottom:6px;color:#222}
  select,input[type=date],input[type=time],input[type=text]{width:100%;padding:8px;border-radius:6px;border:1px solid #ccc;font-size:14px}
  .two{display:grid;grid-template-columns:1fr 1fr;gap:8px}
  table{width:100%;border-collapse:collapse;margin-top:8px;font-size:14px}
  th,td{border:1px solid #ddd;padding:8px;text-align:left}
  th{background:var(--gold);color:var(--blue);text-transform:uppercase;font-size:12px}
  .small{font-size:13px;color:#555}
  button{background:var(--blue);color:#fff;border:none;padding:8px 10px;border-radius:6px;cursor:pointer}
  button.secondary{background:var(--gold);color:var(--blue);border:1px solid var(--blue)}
  .muted{background:#fafafa;padding:10px;border-radius:6px;border:1px dashed #eee}
  .row{display:flex;gap:8px;align-items:center}
  .flex{display:flex;gap:8px}
  .right{display:flex;justify-content:flex-end;gap:8px}
  .link{background:transparent;color:var(--blue);border:1px solid rgba(13,59,102,0.12);padding:6px;border-radius:6px;cursor:pointer}
  .assign-select{width:100%}
</style>
</head>
<body>

<header>
  <h1>Contingency Plan Generator</h1>
  <div class="controls">
    <button onclick="goBack()">← Back to Dashboard</button>
    <button class="secondary" onclick="exportContingencyCSV()">Export Contingency CSV</button>
  </div>
</header>

<div class="card">
  <div class="two">
    <div>
      <label for="absentSelect">Select Absent Teacher</label>
      <select id="absentSelect"><option value="">-- Select teacher --</option></select>
    </div>
    <div>
      <label for="absentDate">Date of Absence</label>
      <input id="absentDate" type="date">
    </div>
  </div>

  <div style="margin-top:10px" class="row">
    <div style="flex:1">
      <label>Teacher's schedule for chosen date (editable)</label>
      <div id="scheduleArea" class="muted small">Select a teacher and date to view schedule.</div>
    </div>
    <div style="width:260px">
      <label>Add schedule row (for selected teacher)</label>
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:6px;margin-bottom:6px">
        <input id="ns_day" placeholder="DAY (e.g., MONDAY)" type="text">
        <input id="ns_time" placeholder="Start-End (HH:MM-HH:MM)" type="text">
      </div>
      <input id="ns_subject" placeholder="Subject / Section" type="text" style="margin-bottom:6px">
      <button onclick="addManualSchedule()">Add & Save</button>
      <div class="small" style="margin-top:6px">If a teacher has no schedule, add rows here and Save. Use 24-hour times: 08:00-09:00</div>
    </div>
  </div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0">Mark Absent Periods & Assign Substitutes</h3>
  <div class="small">Check periods that will be absent, then choose available teachers for each checked slot.</div>

  <div id="periodList" style="margin-top:10px"></div>

  <div class="right" style="margin-top:12px">
    <button onclick="generatePlan()">Generate & Save Plan</button>
  </div>
</div>

<div class="card">
  <h3 style="margin:0 0 8px 0">Generated Contingency Plans (Preview)</h3>
  <div id="planPreview" class="muted small">No plan generated yet.</div>
</div>

<script>
/* Contingency page script
   - Uses same localStorage keys as the dashboard:
     faculty key: 'pis_faculty_v_final'
     contingency key: 'pis_contingency_v_final'
*/

const FAC_KEY = 'pis_faculty_v_final';
const CONT_KEY = 'pis_contingency_v_final';

let faculty = JSON.parse(localStorage.getItem(FAC_KEY) || '[]');
let contingency = JSON.parse(localStorage.getItem(CONT_KEY) || '[]');

const absentSelect = document.getElementById('absentSelect');
const absentDate = document.getElementById('absentDate');
const scheduleArea = document.getElementById('scheduleArea');
const periodList = document.getElementById('periodList');
const planPreview = document.getElementById('planPreview');

function goBack(){
  // navigate back to index - adjust filename as needed
  if(confirm('Go back to dashboard? Unsaved changes will be lost.')) window.location.href = 'index.html';
}

/* populate absent teacher dropdown */
function loadFaculty(){
  faculty = JSON.parse(localStorage.getItem(FAC_KEY) || '[]');
  absentSelect.innerHTML = '<option value="">-- Select teacher --</option>';
  faculty.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t.empno;
    opt.text = `${t.fname} ${t.lname} — ${t.position || ''} (${t.empno})`;
    absentSelect.appendChild(opt);
  });
}
loadFaculty();

/* helper: find teacher by empno */
function getTeacher(empno){ return faculty.find(f => f.empno === empno); }

/* parse a single schedule row string -> {day,start,end,subject,room(optional)}.
   row format in t.schedules is assumed to be objects already; otherwise, we will use stored t.schedules
*/
function getSchedulesForDay(t, dayName){
  if(!t || !t.schedules) return [];
  return (t.schedules || []).filter(s => (s.day||'').toUpperCase() === dayName.toUpperCase())
                .map(s => ({ day: s.day, start: s.start, end: s.end, subject: s.subject || '', room: s.room || '' }));
}

/* when absent selects change -> show schedule */
absentSelect.addEventListener('change', renderSelectedTeacherSchedule);
absentDate.addEventListener('change', renderSelectedTeacherSchedule);

/* Show schedule and period checkboxes for selected teacher & date */
function renderSelectedTeacherSchedule(){
  const emp = absentSelect.value;
  const dateVal = absentDate.value;
  periodList.innerHTML = '';
  planPreview.innerHTML = 'No plan generated yet.';
  if(!emp || !dateVal){
    scheduleArea.innerHTML = '<div class="small">Select both teacher and date to view schedule.</div>';
    return;
  }
  const t = getTeacher(emp);
  if(!t){
    scheduleArea.innerHTML = '<div class="small">Teacher not found.</div>';
    return;
  }

  const d = new Date(dateVal);
  const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  const dayName = days[d.getDay()];

  // get schedule rows for that day
  const rows = getSchedulesForDay(t, dayName);

  if(rows.length === 0){
    scheduleArea.innerHTML = '<div class="small">No schedule for this teacher on that day. Use the form on the right to add rows (then select the date again to refresh).</div>';
    return;
  }

  // build schedule display + checkboxes
  let html = '<table><thead><tr><th></th><th>Time</th><th>Subject / Section</th><th>Room</th></tr></thead><tbody>';
  rows.forEach((r, idx) => {
    html += `<tr>
      <td><input type="checkbox" class="abs-period" data-idx="${idx}" data-start="${r.start}" data-end="${r.end}" /></td>
      <td>${r.start} - ${r.end}</td>
      <td>${r.subject || '-'}</td>
      <td>${r.room || '-'}</td>
    </tr>`;
  });
  html += '</tbody></table>';
  scheduleArea.innerHTML = html;

  // attach event listeners to checkboxes to show substitute pickers
  Array.from(document.querySelectorAll('.abs-period')).forEach(cb => {
    cb.addEventListener('change', onPeriodChecked);
  });

  // Clear periodList
  periodList.innerHTML = '';
}

/* When admin adds manual schedule row for selected teacher */
function addManualSchedule(){
  const emp = absentSelect.value;
  if(!emp){ alert('Select a teacher first (left).'); return; }
  const t = getTeacher(emp);
  if(!t){ alert('Teacher not found'); return; }

  const dayRaw = document.getElementById('ns_day').value.trim().toUpperCase();
  const timeRaw = document.getElementById('ns_time').value.trim();
  const subj = (document.getElementById('ns_subject').value || '').trim();
  if(!dayRaw || !timeRaw || !subj){ alert('Please provide DAY, time range, and subject/section.'); return; }
  // time format validation: start-end
  const parts = timeRaw.split('-').map(s=>s.trim());
  if(parts.length !== 2){
    alert('Time range must be like 08:00-09:00 (24h).');
    return;
  }
  const [start, end] = parts;
  if(start >= end){ alert('Start must be before end.'); return; }

  // ensure teacher.schedules exists
  if(!t.schedules) t.schedules = [];
  t.schedules.push({ day: dayRaw.toUpperCase(), start, end, subject: subj.toUpperCase(), room: '' });

  // persist back to localStorage
  const idx = faculty.findIndex(f => f.empno === t.empno);
  if(idx >= 0){
    faculty[idx] = t;
    localStorage.setItem(FAC_KEY, JSON.stringify(faculty));
    alert('Schedule row added and saved to teacher record.');
    // refresh display for selected date
    renderSelectedTeacherSchedule();
    // clear inputs
    document.getElementById('ns_day').value = '';
    document.getElementById('ns_time').value = '';
    document.getElementById('ns_subject').value = '';
  } else {
    alert('Error: could not save schedule.');
  }
}

/* When a period checkbox is checked, show a row in periodList with substitute selector */
function onPeriodChecked(e){
  const cb = e.target;
  const idx = cb.dataset.idx;
  const start = cb.dataset.start;
  const end = cb.dataset.end;
  const emp = absentSelect.value;
  const dateVal = absentDate.value;
  const d = new Date(dateVal);
  const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  const dayName = days[d.getDay()];

  // create an id for this slot
  const slotId = `slot-${idx}-${start.replace(':','')}-${end.replace(':','')}`;

  if(cb.checked){
    // create container row with substitute dropdown
    const wrapper = document.createElement('div');
    wrapper.id = slotId;
    wrapper.style.marginTop = '8px';
    wrapper.className = 'muted';
    wrapper.innerHTML = `<div style="display:grid;grid-template-columns:1fr 2fr 2fr;gap:8px;align-items:center">
      <div><strong>${dayName} ${start}-${end}</strong></div>
      <div><div class="small">Subject / Section:</div><div id="${slotId}-sub" class="small"></div></div>
      <div>
        <label class="small">Assign substitute</label>
        <select id="${slotId}-assign" class="assign-select"><option value="">Loading...</option></select>
      </div>
    </div>`;
    periodList.appendChild(wrapper);

    // show subject of the slot pulled from teacher schedule
    const t = getTeacher(emp);
    const rows = getSchedulesForDay(t, dayName);
    const s = rows[idx];
    if(s) document.getElementById(`${slotId}-sub`).innerText = s.subject || '-';

    // populate available teachers for this time slot
    populateAvailableTeachersForSlot(slotId, dayName, start, end, emp);
  } else {
    // remove the wrapper and clear any selection stored
    const el = document.getElementById(slotId);
    if(el) el.remove();
  }
}

/* Determine availability: teacher is available if they have no schedule overlapping the start-end on that day */
function intervalsOverlap(startA, endA, startB, endB){ return (startA < endB) && (startB < endA); }

function teacherIsBusyDuring(t, dayName, start, end){
  if(!t || !t.schedules) return false;
  const rows = t.schedules.filter(s => (s.day||'').toUpperCase() === dayName.toUpperCase());
  return rows.some(r => intervalsOverlap(r.start, r.end, start, end));
}

/* Populate substitute dropdown excluding the absent teacher and those busy */
function populateAvailableTeachersForSlot(slotId, dayName, start, end, absentEmpno){
  const sel = document.getElementById(`${slotId}-assign`);
  sel.innerHTML = '<option value="">-- Select substitute --</option>';
  // refresh faculty from storage
  faculty = JSON.parse(localStorage.getItem(FAC_KEY) || '[]');
  faculty.forEach(t => {
    if(t.empno === absentEmpno) return; // skip absent
    // teacher considered available if they are NOT busy during the slot
    if(!teacherIsBusyDuring(t, dayName, start, end)){
      const opt = document.createElement('option');
      opt.value = t.empno;
      opt.text = `${t.fname} ${t.lname} — ${t.position || ''} (${t.empno})`;
      sel.appendChild(opt);
    }
  });

  // if no available teachers
  if(sel.options.length === 1){
    sel.innerHTML = '<option value="">No available teachers</option>';
  }
}

/* Generate and save plan: iterate through selected period rows and save assignments */
function generatePlan(){
  const emp = absentSelect.value;
  const dateVal = absentDate.value;
  if(!emp || !dateVal){ alert('Select absent teacher and date first.'); return; }
  const d = new Date(dateVal);
  const days = ['SUNDAY','MONDAY','TUESDAY','WEDNESDAY','THURSDAY','FRIDAY','SATURDAY'];
  const dayName = days[d.getDay()];

  // collect all slot wrappers
  const wrappers = Array.from(periodList.children).filter(ch => ch.id && ch.id.startsWith('slot-'));
  if(wrappers.length === 0){ alert('No periods selected. Please check periods for absence.'); return; }

  const plans = [];
  for(const w of wrappers){
    const slotId = w.id;
    const assignSel = document.getElementById(`${slotId}-assign`);
    const subEmp = assignSel ? assignSel.value : '';
    const subjEl = document.getElementById(`${slotId}-sub`);
    const subjectText = subjEl ? subjEl.innerText : '';
    // parse times from slot id (we can also read label)
    const label = w.querySelector('div strong') ? w.querySelector('div strong').innerText : '';
    const match = label.match(/([0-9]{2}:[0-9]{2})-([0-9]{2}:[0-9]{2})/);
    const start = match ? match[1] : '';
    const end = match ? match[2] : '';

    if(!subEmp){ if(!confirm(`Period ${label} has no substitute assigned. Continue and save others?`)) return; }

    plans.push({
      id: Date.now() + Math.floor(Math.random()*1000),
      absentEmp: emp,
      absentName: (getTeacher(emp) ? `${getTeacher(emp).fname} ${getTeacher(emp).lname}` : emp),
      subEmp: subEmp || null,
      subName: subEmp ? (getTeacher(subEmp) ? `${getTeacher(subEmp).fname} ${getTeacher(subEmp).lname}` : subEmp) : null,
      subject: subjectText || '',
      date: dateVal,
      day: dayName,
      start, end,
      created: new Date().toISOString()
    });
  }

  // persist plans into contingency storage (append)
  contingency = JSON.parse(localStorage.getItem(CONT_KEY) || '[]');
  contingency = plans.concat(contingency); // newest first
  localStorage.setItem(CONT_KEY, JSON.stringify(contingency));

  // show preview
  renderPlanPreview(plans);
  alert('Contingency plan saved.');
  // clear selection and UI for next round
  periodList.innerHTML = '';
  scheduleArea.innerHTML = '<div class="small">Select both teacher and date to view schedule.</div>';
  absentSelect.value = '';
  absentDate.value = '';
}

/* Show a simple preview of saved plans */
function renderPlanPreview(plans){
  if(!plans || plans.length === 0){ planPreview.innerHTML = '<div class="small">No plan generated yet.</div>'; return; }
  let html = '<table><thead><tr><th>#</th><th>Absent</th><th>Substitute</th><th>Subject</th><th>Date</th><th>Time</th></tr></thead><tbody>';
  plans.forEach((p,i) => {
    html += `<tr><td>${i+1}</td><td>${p.absentName}</td><td>${p.subName || '<em>Unassigned</em>'}</td><td>${p.subject}</td><td>${p.date}</td><td>${p.start}-${p.end}</td></tr>`;
  });
  html += '</tbody></table>';
  planPreview.innerHTML = html;
}

/* Export contingency CSV (same format as dashboard) */
function exportContingencyCSV(){
  const arr = JSON.parse(localStorage.getItem(CONT_KEY) || '[]');
  if(arr.length === 0){ alert('No contingency plans saved.'); return; }
  const rows=[['#','ABSENT_NAME','ABSENT_EMP','SUB_NAME','SUB_EMP','SUBJECT','DATE','START','END','CREATED']];
  arr.forEach((c,i)=> rows.push([i+1,c.absentName,c.absentEmp,c.subName||'',c.subEmp||'',c.subject,c.date,c.start,c.end,c.created]));
  const csv = rows.map(r=> r.map(x=> `"${String(x||'').replace(/"/g,'""')}"`).join(',')).join('\r\n');
  const blob = new Blob(['\ufeff', csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob); const a=document.createElement('a'); a.href=url; a.download=`contingency_plans_${new Date().toISOString().split('T')[0]}.csv`; a.click(); URL.revokeObjectURL(url);
}

/* initial */
loadFaculty();
</script>
</body>
</html>
